---
title: "Orange Pi или свой Git-сервер дома"
date: 2023-01-26T17:00:20+04:00
draft: true
tags: ["linux", "orange-pi", "server"]
categories: ["blog"]
---

В этой заметке обсудим, как поднять свой сервер под небольшой проект, git-сервер или под умный дом за 1-3 тысячи рублей.

## Raspberry Pi для малоимущих

Многие хотя бы раз слышали про [Raspberry Pi](https://www.raspberrypi.com/), это крутые одноплатные компьютеры с
процессорами на [arm](https://en.wikipedia.org/wiki/ARM_architecture_family) архитектуре. Это малютки всем хороши, но
всегда есть какое-то но, и здесь их больше, чем меньше:

1. Цена. Эти штуки до недавнего стояли вменяемые 3-6-8 тысяч рублей, за разного толка конфигурацию, но сейчас цены
   совсем кусачие, это нам не подходит;
2. Закрытый исходный код. В интернете достаточно примеров бекдоров, которые есть в ПО этих плат.
3. Температуры у старших моделей. Не знаю, стоит ли в целом выносить это в минусы, так как это в целом проблема мощных
   одноплатников, но пусть будет.

На рынке существует много альтернатив, но мы остановимся на open-source [Orange Pi](http://www.orangepi.org/) и для
игрулек я себе взял чуть ли не самую дохлую Orange Pi PC Plus на 1Gb RAM и Quad-Core ARM Cortex-A7 1.296GHz. Встала
она мне с корпусом, радиаторами, куллером, двумя блоками питания и флешкой 10 класса на 16Gb за 1 тысячу рублей.

Если сравнить её с Raspberry Pi, то, ну, очевидно, она проиграет во всем, а самое главное, что у Raspberry Pi огромное
комьюнити и вы легко нагуглите любую проблему с пошаговым гайдом к решению, а вот с OrPi придется знатно так забуриться
в гик-сноб-нёрд форумы и попытаться угадать мелодию с двух нот.

Давайте накатим для начала на нее сервер и будем смотреть, что к чему.

## Подготавливаем flash-карту

Первым делом идём
[сюда](http://www.orangepi.org/html/hardWare/computerAndMicrocontrollers/service-and-support/Orange-Pi-Pc-Plus.html) и
определяемся с дистрибутивом. Скажу сразу, что Armbian развивается лучше всех, но мне очень лень пробовать что-то
другое, так что я возьму
[Ubuntu Server](https://drive.google.com/file/d/1F0EMAQJMlMFLUKddkj4Kna07aiOslCUd/view?usp=share_link). К сожалению
там ubuntu server 16.04, но, как говориться, это open-source, ешь, что дают. Для нас это не станет проблемой, мы
обновимся до 20.04 без особых проблем далее.

Далее просто извлекаем удобным для вас способом образ из архива, например вот так:

```bash
tar xvf OrangePi_pc-plus_ubuntu_xenial_server_linux5.3.5_v1.0.tar.gz
```

Нам нужно подготовить флешку к записи, флешка должна быть отформатирована в FAT, для того, чтобы нам можно было создать
загрузочный диск. Это можно сделать через [GParted](https://gparted.org/), если вы на Linux-системе или же через
[HP USB Disk Storage Format Tool](magnet:?xt=urn:btih:A7C23FBC12256A463D12BACDC0314953427DC3B9&tr=http%3A%2F%2Fbt4.t-ru.org%2Fann%3Fmagnet&dn=HP%20USB%20Disk%20Storage%20Format%20Tool%202.2.3%20ENG%2BRUS%20%5B2012%5D)
если вы на MS Windows.

Что там, что там все очень просто, главное отформатировать в FAT.

Далее нам нужно залить операционную систему на подготовленную flash-карту. Для этого можно использовать любое удобное
для вас ПО, будь то [dd](https://www.man7.org/linux/man-pages/man1/dd.1.html),
[Unetbootin](https://unetbootin.github.io/), [Rufus](https://rufus.ie/),

### Загрузочный USB через DD

Узнаем имя нашей USB-flash карточки:

```bash
lsblk
```

или

```bash
fdisk -l
```

Ищем нашу флешку по объему, моя на 16Gb, и имя у него `/dev/sdb`, ваша также будет `/dev/sdb` или `/dev/sdc`.

Далее нам необходимо размонтировать том и отформатировать флешку:

```bash
umount /dev/sdb* && mkfs.vfat /dev/sdb –I
```

Теперь заливаем образ на флешку, образ лежит `~/Downloads/OrPi_ubuntu_1604.iso`:

```bash
dd if=~/Downloads/OrPi_ubuntu_1604.iso of=/dev/sdb
```

Это займет какое-то время, после окончания процесса ваша флешка готова к использованию в Orange Pi.

### Загрузочный USB через Unetbootin или Rufus

Тут совсем все просто, устанавливаете нужный пакет, выбираете образ, выбираете вашу флешку, жмёте старт.

Unetbootin есть во всех репозиториях, просто устанавливаете удобным вам способом, например:

```bash
sudo dnf install unetbootin
```

## Первый запуск

Мы залили на флешку образ, вставили карточку в плату, подключили питание, клавиатуру и монитор, что дальше?

Дальше стоит произвести некоторые манипуляции, после которых можно будет отключить от платы монитор и клавиатуру и
закинуть её куда-нибудь подальше в пыльный угол, но до этого войдем в систему:

```bash
login: root
password: orangepi
```

Далее можно попробовать обновиться, но лучше сразу исправить пару проблем, о которых ниже.

### Исправляем проблемы с доступной памятью flash-карты

Забегая вперед вы 100% столкнетесь с двумя распространенными проблемами:

1. Недоступность всего объема памяти флеш-карты для `/`;
2. Маленький объем в `/boot`

Про первый пункт даже в самой документации есть, не знаю, почему это не исправили спустя столько лет, штош...
open-source moment.

Расширяем доступный объем для файловой системы:

Для нас учтивые разработчики положили скрипт, который нам нужно просто запустить из под `root`:

```bash
/etc/init.d/resize2fs start
```

Если же вы держите flash-карточку в руках, то можно расширить раздел прям через GParted. Мы тем более вернемся к нему
снова в решении следующей проблемы.

Расширяем объем `/boot`:

Ооо, я с этим просидел в поисковике не один час, а решение было очевидное. Суть проблемы:

- Есть раздел `/boot`, у которого выделено 10-15Mb, это очень мало и мы не сможем обновиться;
- Раздел `/boot` отформатирован как 'FAT16', а GParted использует внешний модуль из другой библиотеки для форматирования
  и там (проблема существует с 16 года) до сих пор не добавлена возможность расширить или как-то работать с разделами
  < 256Mb. ~~open-souce moment~~

Мы выйдем из положения просто:

1. Копируем все из папки `/boot` куда-нибудь себе на компьютер;
2. Форматируем раздел в `ext4`;
3. Расширяем его до 512Mb, предварительно откусив это место от раздела `/`;
4. Форматируем расширенный раздел в `FAT16`;
5. Заливаем обратно файлы в `/boot`, которые мы копировали к себе в п. 1.

Отлично! Мы только что починили две проблемы, которые не дали бы нам обновляться в будущем, но осталось еще несколько...

### Исправляем проблему с уходом в сон

У нашей игрушки есть самая бесячая проблема -- включается скринсейвер и плата будто бы засыпает. Такие манипуляции ни
к чему не приведут:

```bash
sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target
```

Все это из-за того, что из коробки у нас устаноновлены ~~за каким-то х_уем~~ иксы (x11-core). Удаляем все это:

```bash
sudo apt-get remove xserver-xorg-core && apt-get remove --purge x11-common && apt-get autoremove && reboot
```

Минус еще одна проблема.

### Обновляем до 20.04

Процесс будет долгим, мы последовательно обновимся до 18.04 а затем до 20.04. Делается это очень просто:

```bash
sudo do-release-upgrade
```

Там нас спросят про переключение source-list и прч., на всё отвечаем согласием. После завершения каждого обновления
перезагружаемся.

После всех действий можно откидывать все лишние шнурки от платы и подключаться к ней через ssh, выясняем IP-адрес
сервера в админке вашего роутера или прям на месте:

```bash
ifconfig | grep 192.168*
```

## Работаем с OrPi удаленно

Чтобы подключиться к нашему серверу по `ssh` просто пишем:

```bash
ssh root@<your_ip>
```

Вводим пароль `orangepi` и все, мы внутри. При первом подключении нас могут спросить про внесение записи в knowhost,
пишем `yes`.

### Показываем сервер наружу через VPN

[Вот тут](https://owlpaw.com/blog/wireguard-vpn) я уже рассказывал, как нам можно поднять VPN, через который мы
соберем устройства в приватной сети. Нам останется только добавить новый Peer для нашего сервера и настроить сам сервер.

По [этой инструкции](https://owlpaw.com/blog/wireguard-vpn/#%d0%b4%d0%be%d0%b1%d0%b0%d0%b2%d0%bb%d1%8f%d0%b5%d0%bc-%d0%bf%d0%b5%d1%80%d0%b2%d1%8b%d0%b9-peer) генерируем ключи и добавляем Peer на сервере, затем перезагружаем службу.

Я добавлял Peer с IP `10.0.0.10`, что бы мне проще было запомнить, так что дальше я буду использовать в примере этот
адрес.

Дальше переходим на наш OrPi сервер и там устанавливаем `wireguard-tools`

```bash
sudo apt install -y wireguard-tools
```

Создаем файл конфигурации `/etc/wireguard/wg0.conf` и вставляем в него это (поменяв ip-внешнего сервера и ключи на
свои):

```bash
[Interface]
PrivateKey = <YOUT_PRIVATE_KEY>
Address = 10.0.0.10/32
DNS = 8.8.8.8

[Peer]
PublicKey = <SERVER-PUBLICKEY>
Endpoint = <SERVER-IP>:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 20

```

Затем прокинем аляс, что бы не так страшно было набирать команды:

```bash
vim ~/.bashrc
```

В конец файла добавляем:

```bash
alias vpn-on='wg-quick up wg0'
alias vpn-off='wg-quick down wg0'
```

Сохраняем и перечитываем конфиг:

```bash
source ~/.bashrc
```

Включаем vpn:

```
vpn-on
```

Добавим в cron задачу, что бы после рестарта включался vpn:

```bash
crontab -e
```

Добавляем в конец файла следующее:

```bash
@reboot sleep 60 && wg-quick up wg0 >>/tmp/cron_log 2>&1

```

Сохраняемся. Вы великолепны! Теперь вы можете подключиться к своему серверу **не** из локальной сети:

```bash
ssh root@10.0.0.10
```

## Поднимаем свой Gitea Git-сервер

//TODO

## Благодарности серому волшебнику

Если текст был полезен и ты не можешь усмирить желание быть благодарным, то вот мои кошелечки (USDT и TRX кошельки одинаковые, да, это не ошибка):

**Tether (TRC-20, USDT):**

```markdown
TYvFYUV3h5HwqfyTxskGQK7nDbUHTcwPn2
```

**Tron (TRX):**

```markdown
TYvFYUV3h5HwqfyTxskGQK7nDbUHTcwPn2
```

**Monero (XMR):**

```markdown
4AbxbT9vrNQTUDCQEPwVLYZq2zTEYzNr9ZzTLaq9YcwVfdxwkWjZ6FsewuXVDXPk7x2rE6FZACmLePPgJEcY4rm1GSHkwTZ
```
