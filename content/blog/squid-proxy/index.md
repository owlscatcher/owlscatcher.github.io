---
draft: true
---

В этой заметке разберемся, как поднять прокси для apt или в целом для http/https и направить траффик через него.

## У нас было...

Для начала расскажу, зачем я вообще занялся этим, так как проксировать траффик можно кучей способов, почему именно 
симпл-димпл-прокси, а не просто VPN или что-то такое.

У меня был:
- Компьютер, подключённый в локальную сеть через маршрутизатор и к внешней сети. На компьютере настроены маршруты, 
чтобы только определенный траффик шел в локальную сеть (запросы типа 192.168.ххх.ххх и похожие), а остальной траффик 
тёк через внешнюю сеть. Компьютер смотрит на внешнюю сеть **через VPN** чтобы иметь доступ до моего локального домашнего 
сервера. Да, схема замудренная, но что стоит вынести из этого, что это **единственный** компьютер в сети, который может 
смотреть на внешнюю сеть.
- Сервер, на котором крутятся базы данных, который подключён в локальную сеть и не имеющий доступ к внешней;
- Сервер, на котором крутятся приложения, который подключен в локальную сеть и не имеющий доступ к внешней.

Компьютер смотрит на внешнюю сеть **через VPN** чтобы иметь 
доступ до моего локального домашнего сервера. Да, схема замудренная, но что стоит вынести из этого, что это 
**единственный** компьютер в сети, который может смотреть на внешнюю сеть.

Я просто в край \_\_\_\_\_\_\_\_ бегать с флешкой, подключать монитор к серверам и работать руками прям там, или же 
заливать на какую-то шару необходимые пакеты, выкачивать их и возиться с установкой через SSH, а потом еще и какой-то 
зависимости как обычно не хватит и ничего не поставить и тд. Короче, кто хоть раз сталкивался с автономно работающим 
сервером, на который требуется установить какой-то пакет сейчас явно почувствовал жжение чуть ниже поясницы. Хочется 
простого и понятного `apt install -y the-best-app-pkg`. 

## Начальная конфигурация сети

В моём примере будет несколько маршрутизаторов в одной локальной сети, это нужно будет в дальнейшем, чтобы проксировать 
траффик из одной "локальной" сети в другую.

На компьютере настроены маршруты, чтобы только определенный траффик шел в локальную сеть (запросы типа 192.168.ххх.ххх 
и похожие), а остальной траффик тёк через внешнюю сеть.

```bash
sudo ip route add 192.168.10.0/24 dev wlo1 via 192.168.90.1
sudo ip route add 172.15.0.0/24 dev wlo1 via 192.168.90.1
```

Где:
- `192.168.10.0/24` локальная сеть **до моего маршрутизатора**;
- `172.15.xxx.0/24` локальная сеть **до маршрутизатора сети** `192.168.10.0/24`;
- `192.168.90.0/24` локальная сеть **после моего маршрутизатора** (в которой и находится мой компьютер);
- `192.168.90.1` **gateway** для маршрутов на моём компьютере.

Следите за руками, как говорится, потому что важно не запутаться на этом этапе из какой сети в какую мы будем двигать 
траффик.

## Кто такой Squid

## Проксируем трафик

Если используем zsh, как в моём случае, то:

```bash
vim ~/.zshrc_proxy
```

Есди стандартно bash, то:

```
vim ~/.bashrc_proxy
```

Помещаем туда экспорт env переменных:

```bash
export http_proxy="http://proxy_ip:proxy_port"
export https_proxy="http://proxy_ip:proxy_port"
```

Перечитываем файл:

Для zsh:

```
source ~/.zshrc_proxy
```

Ну а для bash догадаетесь, как справиться =).

## Благодарности серому волшебнику

Если текст был полезен и ты не можешь усмирить желание быть благодарным, то можешь: 

Воспользоваться моей реферальной ссылкой на TimeWeb:

{{< timeweb >}}

Воспользоваться моей реферальной ссылкой на DigitalOcean:

{{< digitalocean >}}

Или же закинуть монету в мой кошелёк (USDT и TRX кошельки одинаковые, да, это не ошибка):

**Tether (TRC-20, USDT):**

```markdown
TYvFYUV3h5HwqfyTxskGQK7nDbUHTcwPn2
```

**Tron (TRX):**

```markdown
TYvFYUV3h5HwqfyTxskGQK7nDbUHTcwPn2
```

**Monero (XMR):**

```markdown
4AbxbT9vrNQTUDCQEPwVLYZq2zTEYzNr9ZzTLaq9YcwVfdxwkWjZ6FsewuXVDXPk7x2rE6FZACmLePPgJEcY4rm1GSHkwTZ
```
